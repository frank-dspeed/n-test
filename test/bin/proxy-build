#!/usr/bin/env bash
# Unoffical bash safe mode
set -euo pipefail
BIN_DIRECTORY="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

waitproxy() {
    while ! nc -z localhost 8080 ; do sleep 1 ; done
}

if nc -z localhost 8080; then
  echo "Error: port 8080 already in use. Is mitmdump already running?"
  exit 2
fi

echo "Launching proxy..."
mitmdump -w proxy~~.dump &> /dev/null &
mitm_process="$!"
echo "Waiting for proxy..."
waitproxy

echo "Recording downloads..."

source tests/shared_functions.bash
unset_n_env
setup_tmp_prefix
install_dummy_node

# Hack curl to avoid certificate issues with proxy
readonly CURL_HOME="$(dirname "${BIN_DIRECTORY}")/config"
export CURL_HOME

# Go through proxy so it can record traffic, http for taobao redirects
readonly http_proxy="$(hostname):8080"
export http_proxy
readonly https_proxy="$(hostname):8080"
export https_proxy

# Run commands we want to cache downloads for
set -x
# Using 4.9.1 as a well known old version (which is no longer getting updated so does not change)
n --download "4"
docker-compose run ubuntu-curl n --download 4
set +x

rm -rf "${TMP_PREFIX_DIR}"
echo "Stopping proxy"
kill "${mitm_process}"

