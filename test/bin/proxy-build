#!/usr/bin/env bash
# Unoffical bash safe mode
set -euo pipefail
BIN_DIRECTORY="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

waitproxy() {
    while ! nc -z localhost 8080 ; do sleep 1 ; done
}

mitmdump -w proxy~~.dump &> /dev/null &
mitm_process="$!"
waitproxy

# nvh setup
source tests/unset-n-env.bash
# Use temporary directory
readonly N_PREFIX="$(mktemp -d)"
export N_PREFIX
# Hack curl to avoid certificate issues with proxy
readonly CURL_HOME="$(dirname "${BIN_DIRECTORY}")/config"
export CURL_HOME

echo "Loading up cache..."

# Go through proxy so it can record traffic, http for taobao redirects
readonly http_proxy="$(hostname):8080"
export http_proxy
readonly https_proxy="$(hostname):8080"
export https_proxy

# Run commands we want to cache network calls
set -x
# Using 4.9.1 as a well known old version (which is no longer getting updated so does not change)
n "4.9.1"
docker-compose run ubuntu-curl n 4.9.1
set +x

rm -rf "${N_PREFIX}"
kill "${mitm_process}"

